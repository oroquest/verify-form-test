<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sikura – Adressbestätigung</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f5f6f8; margin:0; }
    .container { max-width:760px; margin:32px auto; background:#fff; padding:24px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .row { display:flex; gap:16px; }
    .row > div { flex:1; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input[type="text"], textarea, select {
      width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; background:#fff;
    }
    input[readonly] { background:#f3f4f6; color:#6b7280; }
    .language-switcher { display:flex; justify-content:flex-end; margin-bottom:8px; }
    .checkbox-group { margin-top:12px; }
    .checkbox-line { display:flex; gap:8px; align-items:flex-start; }
    .hint { font-size:14px; color:#6b7280; margin-top:6px; }
    .ctx { background:#f9fafb; border:1px solid #e5e7eb; padding:12px; border-radius:10px; margin:12px 0 16px; }
    .field-error { color:#b91c1c; font-size:13px; margin-top:4px; display:none; }
    .ok { color:#065f46; margin:10px 0; display:none; }
    button { margin-top:18px; padding:12px 18px; border:0; background:#0f172a; color:#fff; border-radius:10px; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .logo { height:48px; margin-bottom:12px; }
    .hidden { display:none; }
    .error-field { border-color:#b91c1c !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="language-switcher">
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
        <option value="en">English</option>
      </select>
    </div>

    <img src="siku_logo.png" alt="Sikura Life" class="logo" />
    <h2 id="title">Bitte bestätigen Sie Ihre Adresse</h2>
    <p id="intro" class="hint">Felder sind vorbefüllt und können bei Bedarf aktualisiert werden.</p>

    <div id="ctx-box" class="ctx"></div>

    <div id="gate-error" class="field-error hidden"></div>
    <div id="gate-ok" class="ok hidden"></div>

    <form id="verify-form" class="hidden" method="POST" action="/.netlify/functions/verify_submit" novalidate>
      <!-- Hidden: email/lang/id/token/em -->
      <input type="hidden" id="email" name="email" />
      <input type="hidden" id="lang" name="lang" />
      <input type="hidden" id="id"    name="id"    />
      <input type="hidden" id="token" name="token" />
      <input type="hidden" id="em"    name="em"    />

      <label for="glaeubiger" id="lbl-glaeubiger">Gläubiger‑Nr.</label>
      <input type="text" id="glaeubiger" name="glaeubiger" readonly required />
      <div class="hint" id="hint-glaeubiger">Nummer des Gläubigers.</div>
      <div class="field-error" id="err-glaeubiger"></div>

      <label for="firstname" id="lbl-firstname">Vorname</label>
      <input type="text" id="firstname" name="firstname" required readonly />
      <div class="hint" id="hint-firstname">Vorname gemäss Personalausweis.</div>
      <div class="field-error" id="err-firstname"></div>

      <label for="name" id="lbl-name">Nachname</label>
      <input type="text" id="name" name="name" required readonly />
      <div class="hint" id="hint-name">Nachname gemäss Personalausweis.</div>
      <div class="field-error" id="err-name"></div>

      <div class="row">
        <div>
          <label for="strasse" id="lbl-strasse">Strasse</label>
          <input type="text" id="strasse" name="strasse" required />
          <div class="hint" id="hint-strasse">Strassenname gemäss offizieller Adresse ohne Hausnummer.</div>
          <div class="field-error" id="err-strasse"></div>
        </div>
        <div style="max-width:180px;">
          <label for="hausnummer" id="lbl-hausnummer">Nr.</label>
          <input type="text" id="hausnummer" name="hausnummer" required />
          <div class="hint" id="hint-hausnummer">Hausnummer gemäss offizieller Adresse.</div>
          <div class="field-error" id="err-hausnummer"></div>
        </div>
      </div>

      <div class="row">
        <div style="max-width:200px;">
          <label for="plz" id="lbl-plz">PLZ</label>
          <input type="text" id="plz" name="plz" required inputmode="numeric" autocomplete="postal-code" />
          <div class="hint" id="hint-plz">Postleitzahl gemäss Land (CH/LI = 4 Ziffern, DE/IT = 5 Ziffern).</div>
          <div class="field-error" id="err-plz"></div>
        </div>
        <div>
          <label for="ort" id="lbl-ort">Ort</label>
          <input type="text" id="ort" name="ort" required />
          <div class="hint" id="hint-ort">Ort gemäss offizieller Adresse.</div>
          <div class="field-error" id="err-ort"></div>
        </div>
      </div>

      <label for="country" id="lbl-country">Land</label>
      <input type="text" id="country" name="country" required />
      <div class="hint" id="hint-country">Land gemäss offizieller Adresse.</div>
      <div class="field-error" id="err-country"></div>

      <div class="checkbox-group">
        <label class="checkbox-line">
          <input type="checkbox" id="confirm" name="confirm" required />
          <span id="txt-confirm">Ich bestätige, dass die angegebenen Daten korrekt sind.</span>
        </label>
        <div class="field-error" id="err-confirm"></div>
      </div>
      <div class="checkbox-group">
        <label class="checkbox-line">
          <input type="checkbox" id="privacy" name="privacy" required />
          <span id="txt-privacy">Ich stimme der Verarbeitung meiner Daten gemäss DSGVO zu.</span>
        </label>
        <div class="field-error" id="err-privacy"></div>
      </div>

      <button type="submit" id="btn-submit">Absenden</button>
      <div class="hint" id="hint-expiry">Hinweis: Der Bestätigungslink ist aus Sicherheitsgründen 7 Tage gültig.</div>
    </form>
  </div>

  <script>
    // Minimal i18n for errors (DE only here since UI is DE by default; plug in others if needed)
    const i18n = {
      de: {
        errRequired: "Pflichtfeld – bitte ausfüllen.",
        errDigits: "Es sind nur Ziffern erlaubt.",
        errZIPLenCH: "PLZ muss 4 Ziffern haben (CH).",
        errZIPLenLI: "PLZ muss 4 Ziffern haben (LI).",
        errZIPLenIT: "PLZ muss 5 Ziffern haben (IT).",
        errZIPLenDE: "PLZ muss 5 Ziffern haben (DE).",
        gateFail: "Verifizierung fehlgeschlagen. Der Link ist ungültig oder abgelaufen.",
        gateOk: "Link geprüft – Formular freigeschaltet."
      }
    };
    const lang = 'de';

    function showError(id, keyOrText) {
      const input = document.getElementById(id);
      const errEl = document.getElementById('err-' + id);
      if (input) input.classList.add('error-field');
      const msg = i18n[lang][keyOrText] || keyOrText || "";
      if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
    }
    function clearError(id) {
      const input = document.getElementById(id);
      const errEl = document.getElementById('err-' + id);
      if (input) input.classList.remove('error-field');
      if (errEl) { errEl.textContent = ""; errEl.style.display = 'none'; }
    }

    function normalizeCountry(raw) {
      const s = (raw || "").trim().toLowerCase();
      if (!s) return "";
      if (["ch","che","schweiz","switzerland","suisse","svizzera"].includes(s)) return "CH";
      if (["li","liechtenstein","lichtenstein"].includes(s)) return "LI";
      if (["it","ita","italien","italia","italy"].includes(s)) return "IT";
      if (["de","deu","deutschland","germany","alemania"].includes(s)) return "DE";
      return "";
    }

    // --- Hard block non-digits for PLZ ---
    (function lockPLZ() {
      const el = document.getElementById('plz');
      // Block at the source (typing, paste, drag/drop) via beforeinput
      el.addEventListener('beforeinput', (e) => {
        // Allow deletions, etc.
        if (e.inputType && e.inputType.startsWith('delete')) return;
        const data = e.data;
        if (data && /\\D/.test(data)) {
          e.preventDefault();
          return false;
        }
      });
      // Paste fallback (some browsers give data=null on beforeinput)
      el.addEventListener('paste', (e) => {
        const t = (e.clipboardData || window.clipboardData).getData('text');
        if (/\\D/.test(t)) {
          e.preventDefault();
          const selStart = el.selectionStart ?? el.value.length;
          const selEnd = el.selectionEnd ?? el.value.length;
          el.value = el.value.slice(0, selStart) + t.replace(/\\D+/g,'') + el.value.slice(selEnd);
        }
      });
      // Drop fallback
      el.addEventListener('drop', (e) => {
        e.preventDefault();
      });
      // Final guard
      el.addEventListener('input', (e) => {
        const filtered = e.target.value.replace(/\\D+/g, '');
        if (filtered !== e.target.value) e.target.value = filtered;
      });
      // On blur trim
      el.addEventListener('blur', (e) => {
        e.target.value = (e.target.value || '').trim();
      });
    })();

    function validateField(id) {
      clearError(id);
      const v = (document.getElementById(id).value || "").trim();
      if (!v) { showError(id, 'errRequired'); return false; }

      if (id === 'plz') {
        // Digits-only, then length by country
        if (!/^\\d+$/.test(v)) { showError('plz','errDigits'); return false; }
        const cc = normalizeCountry(document.getElementById('country').value);
        if (cc === 'CH' && v.length !== 4) { showError('plz','errZIPLenCH'); return false; }
        if (cc === 'LI' && v.length !== 4) { showError('plz','errZIPLenLI'); return false; }
        if (cc === 'IT' && v.length !== 5) { showError('plz','errZIPLenIT'); return false; }
        if (cc === 'DE' && v.length !== 5) { showError('plz','errZIPLenDE'); return false; }
      }
      return true;
    }

    (function init() {
      // Required fields validation on blur
      ['firstname','name','strasse','hausnummer','plz','ort','country'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => clearError(id));
        el.addEventListener('blur', () => validateField(id));
      });

      // Submit validation
      document.getElementById('verify-form').addEventListener('submit', (e) => {
        let hasError = false;
        ['firstname','name','strasse','hausnummer','plz','ort','country'].forEach(id => {
          if (!validateField(id)) hasError = true;
        });
        if (!document.getElementById('confirm').checked) { showError('confirm', 'Bitte bestätigen Sie die Richtigkeit der Angaben.'); hasError = true; }
        if (!document.getElementById('privacy').checked) { showError('privacy', 'Bitte stimmen Sie der DSGVO‑Verarbeitung zu.'); hasError = true; }
        if (hasError) { e.preventDefault(); }
      });
    })();
  </script>
</body>
</html>
