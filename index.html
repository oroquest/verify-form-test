<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sikura – Adressbestätigung</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f5f6f8; margin:0; }
    .container { max-width:760px; margin:32px auto; background:#fff; padding:24px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .row { display:flex; gap:16px; }
    .row > div { flex:1; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input[type="text"], textarea, select { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; background:#fff; }
    input[readonly] { background:#f3f4f6; color:#6b7280; }
    .language-switcher { display:flex; justify-content:flex-end; margin-bottom:8px; }
    .checkbox-group { margin-top:12px; }
    .checkbox-line { display:flex; gap:8px; align-items:flex-start; }
    .hint { font-size:14px; color:#6b7280; margin-top:6px; }
    .ctx { background:#f9fafb; border:1px solid #e5e7eb; padding:12px; border-radius:10px; margin:12px 0 16px; }
    .field-error { color:#b91c1c; font-size:13px; margin-top:4px; display:none; }
    .ok { color:#065f46; margin:10px 0; display:none; }
    button { margin-top:18px; padding:12px 18px; border:0; background:#0f172a; color:#fff; border-radius:10px; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .logo { height:48px; margin-bottom:12px; }
    .hidden { display:none; }
    .error-field { border-color:#b91c1c !important; }
    .linkline { margin-top:4px; }
    #gate-error { padding:8px 12px; background:#fff1f2; border:1px solid #fecdd3; border-radius:10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sprache & Logo -->
    <div class="language-switcher">
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
        <option value="en">English</option>
      </select>
    </div>
    <img src="siku_logo.png" alt="Sikura Life" class="logo" />

    <h2 id="title">Bitte bestätigen Sie Ihre Adresse</h2>
    <p id="intro" class="hint">Felder sind vorbefüllt und können bei Bedarf aktualisiert werden.</p>

    <div id="ctx-box" class="ctx"></div>

    <div id="gate-error" class="field-error hidden" role="alert" aria-live="polite"></div>
    <div id="gate-ok" class="ok hidden"></div>

    <!-- Formular -->
    <form id="verify-form" class="hidden" method="POST" action="/.netlify/functions/verify_submit" novalidate>
      <!-- Hidden: email/lang/id/token/em -->
      <input type="hidden" id="email" name="email" />
      <input type="hidden" id="lang" name="lang" />
      <input type="hidden" id="id"    name="id"    />
      <input type="hidden" id="token" name="token" />
      <input type="hidden" id="em"    name="em"    />

      <label for="glaeubiger">Gläubiger-Nr.</label>
      <input type="text" id="glaeubiger" name="glaeubiger" readonly required />

      <label for="firstname">Vorname</label>
      <input type="text" id="firstname" name="firstname" required readonly />

      <label for="name">Nachname</label>
      <input type="text" id="name" name="name" required readonly />

      <div class="row">
        <div>
          <label for="strasse">Strasse</label>
          <input type="text" id="strasse" name="strasse" required />
        </div>
        <div style="max-width:180px;">
          <label for="hausnummer">Nr.</label>
          <input type="text" id="hausnummer" name="hausnummer" required />
        </div>
      </div>

      <div class="row">
        <div style="max-width:200px;">
          <label for="plz">PLZ</label>
          <input type="text" id="plz" name="plz" required />
        </div>
        <div>
          <label for="ort">Ort</label>
          <input type="text" id="ort" name="ort" required />
        </div>
      </div>

      <label for="country">Land</label>
      <input type="text" id="country" name="country" required />

      <div class="checkbox-group">
        <label class="checkbox-line">
          <input type="checkbox" id="confirm" name="confirm" required />
          <span>Ich bestätige, dass die angegebenen Daten korrekt sind.</span>
        </label>
      </div>
      <div class="checkbox-group">
        <label class="checkbox-line">
          <input type="checkbox" id="privacy" name="privacy" required />
          <span>Ich stimme der Verarbeitung meiner Daten gemäss DSGVO zu.</span>
        </label>
      </div>

      <button type="submit" id="btn-submit">Absenden</button>
    </form>
  </div>

  <script>
    function qs(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name) || "";
    }

    function b64urlDecode(str) {
      if (!str) return "";
      let clean = str.trim().replace(/[^A-Za-z0-9\-_]/g, ""); // Sonderzeichen raus
      try {
        let s = clean.replace(/-/g,'+').replace(/_/g,'/');
        while (s.length % 4 !== 0) s += '=';
        return decodeURIComponent(escape(atob(s)));
      } catch { return ""; }
    }

    function safeSet(id, value) {
      if (value !== undefined && value !== null && String(value).trim() !== "") {
        document.getElementById(id).value = value;
      }
    }

    (async function init() {
      const id = qs('id');
      const token = qs('token');
      const em = qs('em');

      const email = b64urlDecode(em).trim();
      safeSet('email', email);
      safeSet('id', id);
      safeSet('token', token);
      safeSet('em', em);

      let data = null;
      try {
        let resp = await fetch('/.netlify/functions/get_contact?email=' + encodeURIComponent(email));
        if (resp.ok) {
          data = await resp.json();
        }
        if (!data || !Object.keys(data).length) {
          // Fallback
          resp = await fetch('/.netlify/functions/get_contact?id=' + encodeURIComponent(id));
          if (resp.ok) data = await resp.json();
        }
      } catch (e) {}

      if (!data || !Object.keys(data).length) {
        document.getElementById('gate-error').textContent = "Verifizierung fehlgeschlagen – keine Daten.";
        document.getElementById('gate-error').classList.remove('hidden');
        return;
      }

      const getVal = (obj, keys) => {
        for (const k of keys) {
          if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") {
            return obj[k];
          }
        }
        return "";
      };

      safeSet('glaeubiger', getVal(data, ['glaeubiger','gläubiger','Glaeubiger']));
      safeSet('firstname', getVal(data, ['firstname','vorname','Firstname']));
      safeSet('name', getVal(data, ['name','nachname','Name']));
      safeSet('strasse', getVal(data, ['strasse','Strasse','street']));
      safeSet('hausnummer', getVal(data, ['hausnummer','Hausnummer']));
      safeSet('plz', getVal(data, ['plz','Plz','zip']));
      safeSet('ort', getVal(data, ['ort','Ort','city']));
      safeSet('country', getVal(data, ['country','land','Country']));

      document.getElementById('gate-ok').textContent = "Link geprüft – Formular freigeschaltet.";
      document.getElementById('gate-ok').classList.remove('hidden');
      document.getElementById('verify-form').classList.remove('hidden');
    })();
  </script>
</body>
</html>
