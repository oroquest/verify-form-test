<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sikura – Adressbestaetigung</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f5f6f8; margin:0; }
    .container { max-width:760px; margin:32px auto; background:#fff; padding:24px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .row { display:flex; gap:16px; }
    .row > div { flex:1; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input[type="text"], input[type="email"], textarea, select {
      width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; background:#fff;
    }
    input[readonly] { background:#f3f4f6; color:#6b7280; }
    .language-switcher { display:flex; justify-content:flex-end; margin-bottom:8px; }
    .checkbox-group { margin-top:12px; }
    .checkbox-line { display:flex; gap:8px; align-items:flex-start; }
    .hint { font-size:14px; color:#6b7280; margin-top:6px; }
    .ctx { background:#f9fafb; border:1px solid #e5e7eb; padding:12px; border-radius:10px; margin:12px 0 16px; }
    .field-error { color:#b91c1c; font-size:13px; margin-top:4px; display:none; }
    .error { color:#b91c1c; margin:10px 0; display:none; }
    .ok { color:#065f46; margin:10px 0; display:none; }
    button { margin-top:18px; padding:12px 18px; border:0; background:#0f172a; color:#fff; border-radius:10px; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .logo { height:48px; margin-bottom:12px; }
    .hidden { display:none; }
    .error-field { border-color:#b91c1c !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="language-switcher">
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
        <option value="en">English</option>
      </select>
    </div>

    <img src="siku_logo.png" alt="Sikura Life" class="logo" />
    <h2 id="title">Bitte bestaetigen Sie Ihre Adresse</h2>
    <p id="intro" class="hint">Felder sind vorbefuellt und koennen bei Bedarf aktualisiert werden.</p>

    <div id="ctx-box" class="ctx"></div>

    <div id="gate-error" class="error hidden"></div>
    <div id="gate-ok" class="ok hidden"></div>

    <form id="verify-form" class="hidden" method="POST" action="/.netlify/functions/verify_submit" novalidate>
      <!-- Hidden: email/lang/id/token/em -->
      <input type="hidden" id="email" name="email" />
      <input type="hidden" id="lang" name="lang" />
      <input type="hidden" id="id"    name="id"    />
      <input type="hidden" id="token" name="token" />
      <input type="hidden" id="em"    name="em"    />

      <label for="glaeubiger" id="lbl-glaeubiger">Glaeubiger‑Nr.</label>
      <input type="text" id="glaeubiger" name="glaeubiger" readonly required />
      <div class="hint" id="hint-glaeubiger"></div>
      <div class="field-error" id="err-glaeubiger"></div>

      <label for="firstname" id="lbl-firstname">Vorname</label>
      <input type="text" id="firstname" name="firstname" required />
      <div class="hint" id="hint-firstname"></div>
      <div class="field-error" id="err-firstname"></div>

      <label for="name" id="lbl-name">Name</label>
      <input type="text" id="name" name="name" required />
      <div class="hint" id="hint-name"></div>
      <div class="field-error" id="err-name"></div>

      <div class="row">
        <div>
          <label for="strasse" id="lbl-strasse">Strasse</label>
          <input type="text" id="strasse" name="strasse" required />
          <div class="hint" id="hint-strasse"></div>
          <div class="field-error" id="err-strasse"></div>
        </div>
        <div style="max-width:180px;">
          <label for="hausnummer" id="lbl-hausnummer">Nr.</label>
          <input type="text" id="hausnummer" name="hausnummer" required inputmode="numeric" pattern="\\d+" />
          <div class="hint" id="hint-hausnummer"></div>
          <div class="field-error" id="err-hausnummer"></div>
        </div>
      </div>

      <div class="row">
        <div style="max-width:200px;">
          <label for="plz" id="lbl-plz">PLZ</label>
          <input type="text" id="plz" name="plz" required inputmode="numeric" pattern="\\d+" />
          <div class="hint" id="hint-plz"></div>
          <div class="field-error" id="err-plz"></div>
        </div>
        <div>
          <label for="ort" id="lbl-ort">Ort</label>
          <input type="text" id="ort" name="ort" required />
          <div class="hint" id="hint-ort"></div>
          <div class="field-error" id="err-ort"></div>
        </div>
      </div>

      <label for="country" id="lbl-country">Land</label>
      <input type="text" id="country" name="country" required />
      <div class="hint" id="hint-country"></div>
      <div class="field-error" id="err-country"></div>

      <div class="checkbox-group">
        <label class="checkbox-line">
          <input type="checkbox" id="confirm" name="confirm" required />
          <span id="txt-confirm">Ich bestaetige, dass die angegebenen Daten korrekt sind.</span>
        </label>
        <div class="hint" id="hint-confirm"></div>
        <div class="field-error" id="err-confirm"></div>
      </div>
      <div class="checkbox-group">
        <label class="checkbox-line">
          <input type="checkbox" id="privacy" name="privacy" required />
          <span id="txt-privacy">Ich stimme der Verarbeitung meiner Daten gemaess DSGVO zu.</span>
        </label>
        <div class="hint" id="hint-privacy"></div>
        <div class="field-error" id="err-privacy"></div>
      </div>

      <button type="submit" id="btn-submit">Absenden</button>
      <div class="hint" id="hint-expiry">Hinweis: Der Bestaetigungslink ist aus Sicherheitsgruenden 7 Tage gueltig.</div>
    </form>
  </div>

  <script>
    // --------- I18N ---------
    const i18n = {
      de: {
        title: "Bitte bestaetigen Sie Ihre Adresse",
        intro: "Felder sind vorbefuellt und koennen bei Bedarf aktualisiert werden.",
        ctx: "Bitte pruefen Sie die vorbefuellten Angaben und fuellen Sie alle notwendigen Felder aus. Aktivieren Sie ausserdem die Datenbestaetigung und die DSGVO‑Einwilligung.",
        glaeubiger: "Glaeubiger‑Nr.",
        firstname: "Vorname",
        name: "Name",
        strasse: "Strasse",
        hausnummer: "Nr.",
        plz: "PLZ",
        ort: "Ort",
        country: "Land",
        hintGlaeubiger: "Nummer des Anspruchsberechtigten. Dieses Feld ist schreibgeschuetzt.",
        hintFirst: "Rufname gemaess Postanschrift (ohne Titel).",
        hintName: "Familienname gemaess offizieller Adresse.",
        hintStrasse: "Strassenname ohne Hausnummer.",
        hintHausnummer: "Nur Ziffern (keine Buchstaben).",
        hintZIP: "Nur Ziffern (z. B. 8001).",
        hintOrt: "Ort/Gemeinde gemaess Adresse.",
        hintCountry: "Staat in Klartext, z. B. Schweiz, Italia, Germany.",
        confirm: "Ich bestaetige, dass die angegebenen Daten korrekt sind.",
        privacy: "Ich stimme der Verarbeitung meiner Daten gemaess DSGVO zu.",
        hintConfirm: "Bitte aktivieren, damit wir die Adresse verlaesslich uebernehmen koennen.",
        hintPrivacy: "Bitte aktivieren, damit wir Ihre Daten gemaess DSGVO verarbeiten duerfen.",
        submit: "Absenden",
        errRequired: "Pflichtfeld – bitte ausfuellen.",
        errDigits: "Es sind nur Ziffern erlaubt.",
        errConfirm: "Bitte bestaetigen Sie die Richtigkeit der Angaben.",
        errPrivacy: "Bitte stimmen Sie der DSGVO‑Verarbeitung zu.",
        errZIPLenCH: "PLZ muss 4 Ziffern haben (CH).",
        errZIPLenLI: "PLZ muss 4 Ziffern haben (LI).",
        errZIPLenIT: "CAP muss 5 Ziffern haben (IT).",
        errZIPLenDE: "PLZ muss 5 Ziffern haben (DE).",
        expiry: "Hinweis: Der Bestaetigungslink ist aus Sicherheitsgruenden 7 Tage gueltig.",
        gateFail: "Verifizierung fehlgeschlagen. Der Link ist ungueltig oder abgelaufen.",
        gateWarn: "⚠ Hinweis: Testmodus – Der Link waere abgelaufen, das Formular ist dennoch verfuegbar.",
        gateOk: "Link geprueft – Formular freigeschaltet."
      },
      it: {
        title: "Per favore conferma il tuo indirizzo",
        intro: "I campi sono precompilati e possono essere aggiornati se necessario.",
        ctx: "Verifica i dati e compila i campi necessari. Inoltre attiva la conferma dei dati e il consenso GDPR.",
        glaeubiger: "Numero del creditore",
        firstname: "Nome",
        name: "Cognome",
        strasse: "Via",
        hausnummer: "Nr.",
        plz: "CAP",
        ort: "Citta",
        country: "Paese",
        hintGlaeubiger: "Numero dell’avente diritto. Campo di sola lettura.",
        hintFirst: "Nome proprio come nell’indirizzo postale (senza titoli).",
        hintName: "Cognome come nell’indirizzo ufficiale.",
        hintStrasse: "Nome della via senza numero civico.",
        hintHausnummer: "Solo cifre (nessuna lettera).",
        hintZIP: "Solo numeri (es. 00100).",
        hintOrt: "Citta/comune secondo l’indirizzo.",
        hintCountry: "Paese in chiaro, es. Svizzera, Italia, Germany.",
        confirm: "Confermo che i dati forniti sono corretti.",
        privacy: "Acconsento al trattamento dei miei dati secondo il GDPR.",
        hintConfirm: "Seleziona per convalidare i dati.",
        hintPrivacy: "Seleziona per consentire il trattamento dei dati (GDPR).",
        submit: "Invia",
        errRequired: "Campo obbligatorio – compila per favore.",
        errDigits: "Sono consentite solo cifre.",
        errConfirm: "Conferma che i dati sono corretti.",
        errPrivacy: "Fornisci il consenso GDPR.",
        errZIPLenCH: "Il CAP deve avere 4 cifre (CH).",
        errZIPLenLI: "Il CAP deve avere 4 cifre (LI).",
        errZIPLenIT: "Il CAP deve avere 5 cifre (IT).",
        errZIPLenDE: "Il CAP deve avere 5 cifre (DE).",
        expiry: "Nota: Per motivi di sicurezza il link e valido per 7 giorni.",
        gateFail: "Verifica non riuscita. Il link non e valido o e scaduto.",
        gateWarn: "⚠ Avviso: Modalita test – Il link sarebbe scaduto, il modulo e comunque disponibile.",
        gateOk: "Link verificato – modulo abilitato."
      },
      en: {
        title: "Please confirm your address",
        intro: "Fields are pre-filled and can be updated if needed.",
        ctx: "Please review and complete all necessary fields. Also enable the data confirmation and GDPR consent.",
        glaeubiger: "Creditor No.",
        firstname: "First name",
        name: "Last name",
        strasse: "Street",
        hausnummer: "No.",
        plz: "ZIP",
        ort: "City",
        country: "Country",
        hintGlaeubiger: "Number of the entitled party. This field is read-only.",
        hintFirst: "Given name as on your postal address (no titles).",
        hintName: "Family/last name as on the official address.",
        hintStrasse: "Street name without house number.",
        hintHausnummer: "Digits only (no letters).",
        hintZIP: "Digits only (e.g., 10001).",
        hintOrt: "City/municipality as on the address.",
        hintCountry: "Country written out (e.g., Switzerland, Italia, Germany).",
        confirm: "I confirm that the information provided is correct.",
        privacy: "I consent to the processing of my data under GDPR.",
        hintConfirm: "Please enable so we can safely adopt your address.",
        hintPrivacy: "Please enable so we can process your data under GDPR.",
        submit: "Submit",
        errRequired: "Required field — please fill in.",
        errDigits: "Digits only.",
        errConfirm: "Please confirm the information is correct.",
        errPrivacy: "Please provide GDPR consent.",
        errZIPLenCH: "ZIP must be 4 digits (CH).",
        errZIPLenLI: "ZIP must be 4 digits (LI).",
        errZIPLenIT: "ZIP must be 5 digits (IT).",
        errZIPLenDE: "ZIP must be 5 digits (DE).",
        expiry: "Note: For security, the confirmation link is valid for 7 days.",
        gateFail: "Verification failed. The link is invalid or expired.",
        gateWarn: "⚠ Notice: Test mode – The link would be expired, the form is still available.",
        gateOk: "Link verified – form enabled."
      }
    };

    function setLanguage(lang) {
      const d = i18n[lang] || i18n.de;
      document.documentElement.lang = lang;
      document.getElementById('title').textContent = d.title;
      document.getElementById('intro').textContent = d.intro;
      document.getElementById('lbl-glaeubiger').textContent = d.glaeubiger;
      document.getElementById('lbl-firstname').textContent = d.firstname;
      document.getElementById('lbl-name').textContent = d.name;
      document.getElementById('lbl-strasse').textContent = d.strasse;
      document.getElementById('lbl-hausnummer').textContent = d.hausnummer;
      document.getElementById('lbl-plz').textContent = d.plz;
      document.getElementById('lbl-ort').textContent = d.ort;
      document.getElementById('lbl-country').textContent = d.country;
      document.getElementById('txt-confirm').textContent = d.confirm;
      document.getElementById('txt-privacy').textContent = d.privacy;
      document.getElementById('btn-submit').textContent = d.submit;
      document.getElementById('hint-expiry').textContent = d.expiry;
      // Kontext und Hints
      const box = document.getElementById('ctx-box'); if (box) box.textContent = d.ctx;
      const map = [
        ['hint-glaeubiger','hintGlaeubiger'],
        ['hint-firstname','hintFirst'],
        ['hint-name','hintName'],
        ['hint-strasse','hintStrasse'],
        ['hint-hausnummer','hintHausnummer'],
        ['hint-plz','hintZIP'],
        ['hint-ort','hintOrt'],
        ['hint-country','hintCountry'],
        ['hint-confirm','hintConfirm'],
        ['hint-privacy','hintPrivacy'],
      ];
      for (const [id,key] of map) {
        const el = document.getElementById(id);
        if (el) el.textContent = d[key] || '';
      }
    }

    function qs(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name) || "";
    }

    // Base64URL decode (without padding)
    function b64urlDecode(str) {
      try {
        let s = str.replace(/-/g,'+').replace(/_/g,'/');
        while (s.length % 4 !== 0) s += '=';
        return decodeURIComponent(escape(atob(s)));
      } catch (e) {
        try {
          let s = str.replace(/-/g,'+').replace(/_/g,'/');
          while (s.length % 4 !== 0) s += '=';
          return atob(s);
        } catch (err) {
          return "";
        }
      }
    }

    function safeSet(id, value) {
      if (value !== undefined && value !== null && String(value).trim() !== "") {
        document.getElementById(id).value = value;
      }
    }

    function labelFor(id) {
      return (document.getElementById('lbl-'+id)?.textContent || id).trim();
    }

    function showError(id, msgKey) {
      const langEl = document.getElementById('lang').value;
      const dict = i18n[langEl] || i18n.de;
      const input = document.getElementById(id);
      const errEl = document.getElementById('err-' + id);
      if (input) input.classList.add('error-field');
      if (errEl) { errEl.textContent = dict[msgKey] || ""; errEl.style.display = 'block'; }
    }

    function clearError(id) {
      const input = document.getElementById(id);
      const errEl = document.getElementById('err-' + id);
      if (input) input.classList.remove('error-field');
      if (errEl) { errEl.textContent = ""; errEl.style.display = 'none'; }
    }

    function onlyDigits(e) {
      const before = e.target.value;
      const after = before.replace(/\\D+/g, '');
      if (before !== after) e.target.value = after;
    }

    function normalizeCountry(raw) {
      const s = (raw || "").trim().toLowerCase();
      if (!s) return "";
      // Common aliases
      if (["ch","che","schweiz","switzerland","suisse","svizzera"].includes(s)) return "CH";
      if (["li","liechtenstein","lichtenstein"].includes(s)) return "LI";
      if (["it","ita","italien","italia","italy"].includes(s)) return "IT";
      if (["de","deu","deutschland","germany","alemania"].includes(s)) return "DE";
      return ""; // unknown → open rule
    }

    (async function init() {
      // Sprache
      const lang = (qs('lang') || '').toLowerCase();
      const currentLang = ['de','it','en'].includes(lang) ? lang : 'de';
      document.getElementById('language').value = currentLang;
      document.getElementById('lang').value = currentLang;
      setLanguage(currentLang);
      document.getElementById('language').addEventListener('change', (e)=>{
        const l = e.target.value;
        document.getElementById('lang').value = l;
        setLanguage(l);
      });

      // Enforce digits for Hausnummer & PLZ on input
      document.getElementById('hausnummer').addEventListener('input', onlyDigits);
      document.getElementById('plz').addEventListener('input', onlyDigits);

      // URL-Params
      const id = qs('id');
      const token = qs('token');
      const em = qs('em');

      // Guard: Muss vorhanden sein
      if (!id || !token || !em) {
        const msg = i18n[currentLang].gateFail;
        const el = document.getElementById('gate-error'); el.textContent = msg; el.classList.remove('hidden');
        return;
      }

      // Email aus em (Base64URL) decodieren
      let email = "";
      if (em) {
        email = b64urlDecode(em).trim();
      } else {
        email = qs('email') || "";
      }

      // Hidden-Felder setzen
      safeSet('email', email);
      safeSet('id',    id);
      safeSet('token', token);
      safeSet('em',    em);

      // Daten lookup
      try {
        const resp = await fetch('/.netlify/functions/get_contact?id=' + encodeURIComponent(email));
        if (!resp.ok) throw new Error('lookup failed');
        const data = await resp.json();

        const glaeubiger = (data.glaeubiger ?? data['gläubiger'] ?? "").toString().trim();

        safeSet('glaeubiger', glaeubiger);
        safeSet('firstname', data.firstname);
        safeSet('name', data.name);
        safeSet('strasse', data.strasse);
        safeSet('hausnummer', data.hausnummer);
        safeSet('plz', data.plz);
        safeSet('ort', data.ort);
        safeSet('country', data.country);

        if (glaeubiger !== id) {
          const el = document.getElementById('gate-error');
          el.textContent = i18n[currentLang].gateFail + " (ID mismatch)";
          el.classList.remove('hidden');
          return;
        }

        // ok
        const ok = document.getElementById('gate-ok');
        ok.textContent = i18n[currentLang].gateOk;
        ok.classList.remove('hidden');
        document.getElementById('verify-form').classList.remove('hidden');
      } catch (e) {
        const el = document.getElementById('gate-error');
        el.textContent = i18n[currentLang].gateFail;
        el.classList.remove('hidden');
      }

      // Live-clear errors on input/blur
      const req = ['firstname','name','strasse','hausnummer','plz','ort','country'];
      req.forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => clearError(id));
        el.addEventListener('blur',  () => {
          if (!el.value.trim()) { showError(id, 'errRequired'); }
          else if ((id==='hausnummer' || id==='plz') && /\\D/.test(el.value)) { showError(id, 'errDigits'); }
          else {
            // Extra: plz length depending on country
            if (id === 'plz') {
              const cc = normalizeCountry(document.getElementById('country').value);
              const v = el.value.trim();
              if (cc === 'CH' && v.length !== 4) { showError('plz','errZIPLenCH'); }
              else if (cc === 'LI' && v.length !== 4) { showError('plz','errZIPLenLI'); }
              else if (cc === 'IT' && v.length !== 5) { showError('plz','errZIPLenIT'); }
              else if (cc === 'DE' && v.length !== 5) { showError('plz','errZIPLenDE'); }
              else { clearError('plz'); }
            } else {
              clearError(id);
            }
          }
        });
      });
      ['confirm','privacy'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('change', () => clearError(id));
      });

      // On country change, revalidate PLZ immediately (useful when user edits country after plz)
      document.getElementById('country').addEventListener('input', () => {
        const el = document.getElementById('plz');
        if (!el.value.trim()) return;
        // trigger same blur logic for PLZ
        el.dispatchEvent(new Event('blur'));
      });

      // Submit-Validation (inline errors only)
      document.getElementById('verify-form').addEventListener('submit', (e) => {
        let hasError = false;

        const must = ['firstname','name','strasse','hausnummer','plz','ort','country'];
        must.forEach(id => {
          const el = document.getElementById(id);
          clearError(id);
          if (!el.value || !el.value.trim()) {
            showError(id, 'errRequired'); hasError = true;
          } else if ((id==='hausnummer' || id==='plz') && /\\D/.test(el.value)) {
            showError(id, 'errDigits'); hasError = true;
          }
        });

        // Country-specific PLZ length
        const cc = normalizeCountry(document.getElementById('country').value);
        const plzV = (document.getElementById('plz').value || "").trim();
        if (plzV) {
          if (cc === 'CH' && plzV.length !== 4) { showError('plz','errZIPLenCH'); hasError = true; }
          else if (cc === 'LI' && plzV.length !== 4) { showError('plz','errZIPLenLI'); hasError = true; }
          else if (cc === 'IT' && plzV.length !== 5) { showError('plz','errZIPLenIT'); hasError = true; }
          else if (cc === 'DE' && plzV.length !== 5) { showError('plz','errZIPLenDE'); hasError = true; }
        }

        if (!document.getElementById('confirm').checked) { showError('confirm','errConfirm'); hasError = true; }
        if (!document.getElementById('privacy').checked) { showError('privacy','errPrivacy'); hasError = true; }

        if (hasError) {
          e.preventDefault();
          const first = document.querySelector('.error-field') || document.querySelector('.field-error[style*="block"]');
          if (first && first.focus) first.focus();
          return false;
        }
        return true;
      });
    })();
  </script>
</body>
</html>
