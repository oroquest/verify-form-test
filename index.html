<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Sikura – Adressbestätigung</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f5f6f8;margin:0}
  .container{max-width:760px;margin:32px auto;background:#fff;padding:24px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  label{display:block;margin:12px 0 6px;font-weight:600}
  input[type=text]{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px}
  input[readonly]{background:#f3f4f6;color:#6b7280}
  .row{display:flex;gap:16px}.row>div{flex:1}
  .hidden{display:none}
  #gate-error{margin:8px 0;padding:8px 12px;background:#fff1f2;border:1px solid #fecdd3;border-radius:10px;color:#b91c1c}
  #gate-ok{margin:8px 0;color:#065f46}
</style>
</head>
<body>
<div class="container">
  <h2>Bitte bestätigen Sie Ihre Adresse</h2>
  <div id="gate-error" class="hidden"></div>
  <div id="gate-ok" class="hidden"></div>

  <form id="verify-form" class="hidden" method="POST" action="/.netlify/functions/verify_submit">
    <input type="hidden" id="email" name="email"/>
    <input type="hidden" id="id" name="id"/>
    <input type="hidden" id="token" name="token"/>
    <input type="hidden" id="em" name="em"/>

    <label>Gläubiger‑Nr.</label>
    <input type="text" id="glaeubiger" name="glaeubiger" readonly/>
    <label>Vorname</label>
    <input type="text" id="firstname" name="firstname" readonly/>
    <label>Nachname</label>
    <input type="text" id="name" name="name" readonly/>

    <div class="row">
      <div><label>Strasse</label><input type="text" id="strasse" name="strasse"/></div>
      <div style="max-width:180px"><label>Nr.</label><input type="text" id="hausnummer" name="hausnummer"/></div>
    </div>
    <div class="row">
      <div style="max-width:200px"><label>PLZ</label><input type="text" id="plz" name="plz"/></div>
      <div><label>Ort</label><input type="text" id="ort" name="ort"/></div>
    </div>
    <label>Land</label>
    <input type="text" id="country" name="country"/>

    <button type="submit">Absenden</button>
  </form>
</div>

<script>
const qs = n => new URLSearchParams(location.search).get(n) || "";
function b64urlDecode(s){ if(!s) return ""; s=s.replace(/-/g,"+").replace(/_/g,"/"); while(s.length%4)s+="="; try{return decodeURIComponent(escape(atob(s)))}catch(e){try{return atob(s)}catch{return ""}}}
function setVal(id,v){ if(v!=null && String(v).trim()!=="") document.getElementById(id).value=String(v).trim(); }

(async () => {
  const id=qs("id"), token=qs("token"), em=qs("em");
  const email=b64urlDecode(em) || qs("email") || "";
  if(!id || !token || !em){ const e=document.getElementById("gate-error"); e.textContent="Link ungültig oder unvollständig."; e.classList.remove("hidden"); return; }

  setVal("email",email); setVal("id",id); setVal("token",token); setVal("em",em);

  try{
    // WICHTIG: zuerst per EMAIL suchen (richtiges Param!)
    let resp = await fetch("/.netlify/functions/get_contact?email="+encodeURIComponent(email));
    let data = resp.ok ? await resp.json() : null;

    // Fallback: per ID versuchen, falls Email-Query nichts liefert
    if(!data || !Object.keys(data).length){
      resp = await fetch("/.netlify/functions/get_contact?id="+encodeURIComponent(id));
      data = resp.ok ? await resp.json() : null;
    }
    if(!data || !Object.keys(data).length) throw new Error("no_contact");

    // gläubiger: wenn leer, ID aus URL einsetzen
    let glaeubiger = (data.glaeubiger ?? data["gläubiger"] ?? "").toString().trim();
    if(!glaeubiger) glaeubiger = id;
    setVal("glaeubiger", glaeubiger);

    // restliche Felder
    ["firstname","name","strasse","hausnummer","plz","ort","country"].forEach(k => setVal(k, data[k]));

    document.getElementById("gate-ok").textContent = "Link geprüft – Formular freigeschaltet.";
    document.getElementById("gate-ok").classList.remove("hidden");
    document.getElementById("verify-form").classList.remove("hidden");
  }catch(e){
    const er=document.getElementById("gate-error");
    er.textContent = "Verifizierung fehlgeschlagen oder keine Kontaktdaten gefunden.";
    er.classList.remove("hidden");
  }
})();
</script>
</body>
</html>
