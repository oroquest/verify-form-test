<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sikura – Adressbestätigung</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f5f6f8; margin:0; }
    .container { max-width:760px; margin:32px auto; background:#fff; padding:24px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .row { display:flex; gap:16px; }
    .row > div { flex:1; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input[type="text"], textarea, select { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; background:#fff; }
    input[readonly] { background:#f3f4f6; color:#6b7280; }
    .language-switcher { display:flex; justify-content:flex-end; margin-bottom:8px; }
    .checkbox-group { margin-top:12px; }
    .checkbox-line { display:flex; gap:8px; align-items:flex-start; }
    .hint { font-size:14px; color:#6b7280; margin-top:6px; }
    .ctx { background:#f9fafb; border:1px solid #e5e7eb; padding:12px; border-radius:10px; margin:12px 0 16px; }
    .field-error { color:#b91c1c; font-size:13px; margin-top:4px; display:none; }
    .ok { color:#065f46; margin:10px 0; display:none; }
    button { margin-top:18px; padding:12px 18px; border:0; background:#0f172a; color:#fff; border-radius:10px; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .logo { height:48px; margin-bottom:12px; }
    .hidden { display:none; }
    .error-field { border-color:#b91c1c !important; }
    .linkline { margin-top:4px; }
    #gate-error { padding:8px 12px; background:#fff1f2; border:1px solid #fecdd3; border-radius:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="language-switcher">
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
        <option value="en">English</option>
      </select>
    </div>

    <img src="siku_logo.png" alt="Sikura Life" class="logo" />
    <h2 id="title">Bitte bestätigen Sie Ihre Adresse</h2>
    <p id="intro" class="hint">Felder sind vorbefüllt und können bei Bedarf aktualisiert werden.</p>

    <div id="ctx-box" class="ctx"></div>

    <div id="gate-error" class="field-error hidden" role="alert" aria-live="polite"></div>
    <div id="gate-ok" class="ok hidden"></div>

    <form id="verify-form" class="hidden" method="POST" action="/.netlify/functions/verify_submit" novalidate>
      <input type="hidden" id="email" name="email" />
      <input type="hidden" id="lang" name="lang" />
      <input type="hidden" id="id"    name="id"    />
      <input type="hidden" id="token" name="token" />
      <input type="hidden" id="em"    name="em"    />

      <label for="glaeubiger">Gläubiger-Nr.</label>
      <input type="text" id="glaeubiger" name="glaeubiger" readonly required />

      <label for="firstname">Vorname</label>
      <input type="text" id="firstname" name="firstname" required readonly />

      <label for="name">Nachname</label>
      <input type="text" id="name" name="name" required readonly />

      <div class="row">
        <div>
          <label for="strasse">Strasse</label>
          <input type="text" id="strasse" name="strasse" required />
        </div>
        <div style="max-width:180px;">
          <label for="hausnummer">Nr.</label>
          <input type="text" id="hausnummer" name="hausnummer" required />
        </div>
      </div>

      <div class="row">
        <div style="max-width:200px;">
          <label for="plz">PLZ</label>
          <input type="text" id="plz" name="plz" required />
        </div>
        <div>
          <label for="ort">Ort</label>
          <input type="text" id="ort" name="ort" required />
        </div>
      </div>

      <label for="country">Land</label>
      <input type="text" id="country" name="country" required />

      <button type="submit" id="btn-submit">Absenden</button>
    </form>
  </div>

  <script>
    function qs(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name) || "";
    }

    function b64urlDecode(str) {
      let s = str.replace(/-/g,'+').replace(/_/g,'/');
      while (s.length % 4 !== 0) s += '=';
      return decodeURIComponent(escape(atob(s)));
    }

    function safeSet(id, value) {
      if (value && String(value).trim() !== "") {
        document.getElementById(id).value = value;
      }
    }

    (async function init() {
      const id = qs('id');
      const token = qs('token');
      const em = qs('em');
      const email = b64urlDecode(em).trim();

      safeSet('email', email);
      safeSet('id', id);
      safeSet('token', token);
      safeSet('em', em);

      try {
        const resp = await fetch('/.netlify/functions/get_contact?id=' + encodeURIComponent(email));
        const data = await resp.json();

        let glaeubiger = data.glaeubiger || data["gläubiger"] || "";
        if (!glaeubiger && id) glaeubiger = id; // Fallback hier

        safeSet('glaeubiger', glaeubiger);
        ['firstname','name','strasse','hausnummer','plz','ort','country'].forEach(k => safeSet(k, data[k]));

        document.getElementById('verify-form').classList.remove('hidden');
      } catch (e) {
        document.getElementById('gate-error').textContent = "Fehler beim Laden der Daten.";
        document.getElementById('gate-error').classList.remove('hidden');
      }
    })();
  </script>
</body>
</html>