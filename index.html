<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sikura – Adressbestätigung</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f8; margin:0; }
    .container { max-width:760px; margin:32px auto; background:#fff; padding:24px; border-radius:14px; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input[type="text"] { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; }
    input[readonly] { background:#f3f4f6; color:#6b7280; }
    .row { display:flex; gap:16px; }
    .row > div { flex:1; }
    .hidden { display:none; }
    .ok { color:green; margin:8px 0; }
    .field-error { color:red; font-size:0.9em; display:none; }
  </style>
</head>
<body>
<div class="container">
  <h2>Bitte bestätigen Sie Ihre Adresse</h2>
  <div id="gate-error" class="field-error hidden"></div>
  <div id="gate-ok" class="ok hidden"></div>

  <form id="verify-form" class="hidden" method="POST" action="/.netlify/functions/verify_submit">
    <input type="hidden" id="email" name="email" />
    <input type="hidden" id="lang" name="lang" />
    <input type="hidden" id="id" name="id" />
    <input type="hidden" id="token" name="token" />
    <input type="hidden" id="em" name="em" />

    <label>Gläubiger-Nr.</label>
    <input type="text" id="glaeubiger" name="glaeubiger" readonly />

    <label>Vorname</label>
    <input type="text" id="firstname" name="firstname" readonly />

    <label>Nachname</label>
    <input type="text" id="name" name="name" readonly />

    <label>Strasse</label>
    <input type="text" id="strasse" name="strasse" />

    <label>Nr.</label>
    <input type="text" id="hausnummer" name="hausnummer" />

    <label>PLZ</label>
    <input type="text" id="plz" name="plz" />

    <label>Ort</label>
    <input type="text" id="ort" name="ort" />

    <label>Land</label>
    <input type="text" id="country" name="country" />

    <button type="submit">Absenden</button>
  </form>
</div>

<script>
function qs(name) {
  const p = new URLSearchParams(location.search);
  return p.get(name) || "";
}

function safeSet(id, value) {
  if (value && String(value).trim() !== "") {
    document.getElementById(id).value = value;
  }
}

(async function init() {
  const id = qs('id');
  const token = qs('token');
  const em = qs('em');
  const email = atob(em.replace(/-/g,'+').replace(/_/g,'/'));

  if (!id || !token || !em) {
    document.getElementById('gate-error').textContent = "Link ungültig oder unvollständig.";
    document.getElementById('gate-error').classList.remove('hidden');
    return;
  }

  safeSet('email', email);
  safeSet('id', id);
  safeSet('token', token);
  safeSet('em', em);

  try {
    const resp = await fetch('/.netlify/functions/get_contact?email=' + encodeURIComponent(email));
    if (!resp.ok) throw new Error();
    const data = await resp.json();

    // Fallback: wenn glaeubiger leer → ID aus URL einsetzen
    const glaeubigerVal = (data.glaeubiger || data['gläubiger'] || "").trim();
    safeSet('glaeubiger', glaeubigerVal || id);

    ['firstname','name','strasse','hausnummer','plz','ort','country'].forEach(k => safeSet(k, data[k]));

    document.getElementById('gate-ok').textContent = "Link geprüft – Formular freigeschaltet.";
    document.getElementById('gate-ok').classList.remove('hidden');
    document.getElementById('verify-form').classList.remove('hidden');
  } catch (e) {
    document.getElementById('gate-error').textContent = "Verifizierung fehlgeschlagen.";
    document.getElementById('gate-error').classList.remove('hidden');
  }
})();
</script>
</body>
</html>
